# -*- coding: utf-8 -*-
"""app 3

Automatically generated by Colab.

Original file is located at
Â  Â  https://colab.research.google.com/drive/1GGqoqxoxu4r7WijHHL2bn2a3cKt7SerJ
"""

import streamlit as st
import pandas as pd
import pickle
from datetime import datetime
import plotly.express as px

# ======================
# CONFIG PAGE
# ======================
st.set_page_config(
Â  Â  page_title="Customer Segmentation App",
Â  Â  page_icon="ğŸ“Š",
Â  Â  layout="wide"
)

# ======================
# SIDEBAR COLOR
# ======================
st.markdown("""
Â  Â  <style>

Â  Â  Â  Â  /* ====================== */
Â  Â  Â  Â  /* CARD UNTUK KPI METRICÂ  */
Â  Â  Â  Â  /* ====================== */

Â  Â  Â  Â  [data-testid="stSidebar"] {
Â  Â  Â  Â  Â  Â  background-color: #EF8505Â  !important; /* Kuning muda */
Â  Â  Â  Â  }

	/* Background utama */
Â  Â  Â  Â  [data-testid="stAppViewContainer"] {
Â  Â  Â  Â  Â  Â  background-color: #FFFFFF !important; /* Kuning muda */
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Bagian header (atas) */
Â  Â  Â  Â  [data-testid="stHeader"] {
Â  Â  Â  Â  Â  Â  background-color: #323232 !important;
Â  Â  Â  Â  }
Â  Â  </style>
""", unsafe_allow_html=True)


# ======================
# SIDEBAR MENU
# ======================

st.markdown("""
<style>

Â  Â  /* Hilangkan jarak antar elemen sidebar */
Â  Â  [data-testid="stSidebar"] .element-container {
Â  Â  Â  Â  padding: 0px !important;
Â  Â  Â  Â  margin: 0px !important;
Â  Â  }

Â  Â  /* Khusus gambar */
Â  Â  .sidebar-images img {
Â  Â  Â  Â  margin-bottom: 0px !important;
Â  Â  Â  Â  margin-top: 0px !important;
Â  Â  }

</style>
""", unsafe_allow_html=True)

with st.sidebar:
Â  Â  st.markdown('<div class="sidebar-images">', unsafe_allow_html=True)
Â  Â  st.image("image/alllogo.png", width=250)
Â  Â  st.markdown('</div>', unsafe_allow_html=True)

st.sidebar.title("ğŸ“˜ Navigation")
page = st.sidebar.selectbox(
Â  Â  "Pilih Halaman",
Â  Â  ["Overview", "Dashboard RFM"],
Â  Â  index=0
)

# ======================
# LOAD DATA (DIPAKAI DI 2 HALAMAN)
# ======================
df = pd.read_excel("dataset/data_with_cluster.xlsx")
df2 = pd.read_csv("dataset/flo_data_20k.csv")

if "first_order_date" in df.columns:
Â  Â  df["first_order_date"] = pd.to_datetime(df["first_order_date"])


# ============================================================
# ===============Â  HALAMAN 1 â€” OVERVIEWÂ  ======================
# ============================================================
if page == "Overview":
Â  Â  st.markdown(
Â  Â  "<h1 style='text-align: center;'>Customer Segmentation Project</h1>",
Â  Â  unsafe_allow_html=True
)

Â  Â  st.header("ğŸ“Œ Latar Belakang")
Â  Â  st.write("""
Â  Â  Perubahan perilaku pasar di era digital menuntut strategi pemasaran yang lebih cerdas dan tepat sasaran. Namun, banyak perusahaan masih menggunakan promosi massal yang kurang relevan dengan karakteristik pelanggan, sehingga menimbulkan inefisiensi biaya dan rendahnya tingkat konversi. Untuk mengatasinya, diperlukan peralihan menuju pengambilan keputusan berbasis data melalui segmentasi pelanggan yang lebih actionable. Metode RFM (Recency, Frequency, Monetary) menjadi solusi efektif karena mampu mengukur nilai pelanggan secara kuantitatif. Dengan dukungan algoritma Machine Learning dan dashboard visualisasi, analisis pelanggan dapat dilakukan lebih cepat dan akurat untuk mendukung strategi personalized marketing.
Â  Â  """)

Â  Â  st.header("ğŸ“‚ Dataset")
Â  Â  st.write("""
Â  Â  Dataset dalam proyek berisi informasi yang diperoleh dari perilaku belanja pelanggan di masa lalu yang melakukan pembelian terakhirnya melalui OmniChannel (baik belanja online maupun offline).
Â  Â  """)

Â  Â  st.subheader("Preview Dataset")
Â  Â  st.dataframe(df2.head())

Â  Â  st.subheader("ğŸ§¾ Metadata Dataset")

Â  Â  metadata = {
	Â  Â  "Variabel": [
	Â  Â  Â  Â  "master_id",
	Â  Â  Â  Â  "order_channel",
	Â  Â  Â  Â  "last_order_channel",
	Â  Â  Â  Â  "first_order_date",
	Â  Â  Â  Â  "last_order_date",
	Â  Â  Â  Â  "last_order_date_online",
	Â  Â  Â  Â  "last_order_date_offline",
	Â  Â  Â  Â  "order_num_total_ever_online",
	Â  Â  Â  Â  "order_num_total_ever_offline",
	Â  Â  Â  Â  "customer_value_total_ever_offline",
	Â  Â  Â  Â  "customer_value_total_ever_online",
	Â  Â  Â  Â  "interested_in_categories_12"
	Â  Â  ],
	Â  Â  "Deskripsi": [
	Â  Â  Â  Â  "Unique client number",
	Â  Â  Â  Â  "Channel belanja yang digunakan",
	Â  Â  Â  Â  "Channel pembelian terakhir",
	Â  Â  Â  Â  "Tanggal pembelian pertama",
	Â  Â  Â  Â  "Tanggal pembelian terakhir",
	Â  Â  Â  Â  "Tanggal pembelian online terakhir",
	Â  Â  Â  Â  "Tanggal pembelian offline terakhir",
	Â  Â  Â  Â  "Total transaksi online",
	Â  Â  Â  Â  "Total transaksi offline",
	Â  Â  Â  Â  "Total nilai transaksi offline",
	Â  Â  Â  Â  "Total nilai transaksi online",
	Â  Â  Â  Â  "Kategori belanja dalam 12 bulan terakhir"
	Â  Â  ]
Â  Â  }
	
Â  Â  metadata_df = pd.DataFrame(metadata)
Â  Â  st.dataframe(metadata_df, use_container_width=True)
	
Â  Â  st.info("Gunakan menu di sidebar untuk membuka **Dashboard RFM**.")

# ============================================================
# ===============Â  HALAMAN 2 â€” DASHBOARD RFM ==================
# ============================================================
elif page == "Dashboard RFM":

Â  Â  # ======================
Â  Â  # TITLE
Â  Â  # ======================
Â  Â  st.markdown(
Â  Â  "<h1 style='text-align: center;'>ğŸ“Š Customer Segmentation Dashboard</h1>",
Â  Â  unsafe_allow_html=True
)

Â  Â  # ======================
Â  Â  # LOAD MODELS
Â  Â  # ======================
Â  Â  scaler = pickle.load(open("model/scaler.pkl", "rb"))
Â  Â  pca = pickle.load(open("model/pca.pkl", "rb"))
Â  Â  kmeans = pickle.load(open("model/kmeans.pkl", "rb"))

Â  Â  cluster_reco = {
Â  Â  Â  Â  0: "Prioritas Marketing",
Â  Â  Â  Â  1: "Loyal Customers",
Â  Â  Â  Â  2: "Hibernating",
Â  Â  }

Â  Â  # ======================
Â  Â  # KPI CARDS
Â  Â  # ======================

Â  Â  total_customer = df.shape[0]
Â  Â  total_monetary = df["Monetary"].sum()
Â  Â  total_frequency = df["Frequency"].sum()

Â  Â  kpi1, kpi2, kpi3 = st.columns(3)

Â  Â  with kpi1:
Â  Â  Â  Â  with st.container(border=True):
Â  Â  Â  Â  Â  Â  st.metric("Total Customers", total_customer)

Â  Â  with kpi2:
Â  Â  Â  Â  with st.container(border=True):
Â  Â  Â  Â  Â  Â  st.metric("Total Monetary", f"{total_monetary:,.0f}")

Â  Â  with kpi3:
Â  Â  Â  Â  with st.container(border=True):
Â  Â  Â  Â  Â  Â  st.metric("Total Frequency", f"{total_frequency:,}")

Â  Â  # ======================
Â  Â  # PIE + BAR
Â  Â  # ======================
Â  Â  col1, col2 = st.columns(2)

Â  Â  with col1:
Â  Â  Â  Â  with st.container(border=True):
Â  Â  Â  Â  Â  Â  st.markdown(
Â  Â  Â  Â  Â  Â  Â  Â  "<h3 style='text-align: center;'>Order Channel Distribution</h3>",
Â  Â  Â  Â  Â  Â  Â  Â  unsafe_allow_html=True
Â  Â  Â  Â  Â  Â  )
Â  Â  Â  Â  Â  Â  fig_pie = px.pie(
Â  Â  Â  Â  Â  Â  Â  Â  df,
Â  Â  Â  Â  Â  Â  Â  Â  names="order_channel",
Â  Â  Â  Â  Â  Â  Â  Â  color="order_channel",
Â  Â  Â  Â  Â  Â  Â  Â  color_discrete_sequence= ["#E05F00", "#FAAD00", "#FFC746", "#FFE169"]
Â  Â  Â  Â  Â  Â  )
Â  Â  Â  Â  Â  Â  st.plotly_chart(fig_pie, use_container_width=True)

Â  Â  with col2:
Â  Â  Â  Â  with st.container(border=True):
Â  Â  Â  Â  Â  Â  st.markdown(
Â  Â  Â  Â  Â  Â  Â  Â  "<h3 style='text-align: center;'>Order Count by First Order Date</h3>",
Â  Â  Â  Â  Â  Â  Â  Â  unsafe_allow_html=True
Â  Â  Â  Â  Â  Â  )
Â  Â  Â  Â  Â  Â  fig_bar = px.bar(
Â  Â  Â  Â  Â  Â  Â  Â  df.groupby("first_order_date").size().reset_index(name="count"),
Â  Â  Â  Â  Â  Â  Â  Â  x="first_order_date",
Â  Â  Â  Â  Â  Â  Â  Â  y="count",
Â  Â  Â  Â  Â  Â  Â  Â  color_discrete_sequence=["#323232"]
Â  Â  Â  Â  Â  Â  )
Â  Â  Â  Â  Â  Â  st.plotly_chart(fig_bar, use_container_width=True)

Â  Â  # ======================
Â  Â  # DISTRIBUSI RFM PER CLUSTER
Â  Â  # ======================

Â  Â  st.markdown(
Â  Â  "<h3 style='text-align: center;'>Distribusi RFM Berdasarkan Cluster</h3>",
Â  Â  unsafe_allow_html=True
Â  Â  )

Â  Â  colA, colB, colC = st.columns(3)

Â  Â  cluster_names = {
Â  Â  0: "Low Value Inactive Customer",
Â  Â  1: "High Value Customer",
Â  Â  2: "Medium Customer"
	}

Â  Â  df["Cluster_Name"] = df["Cluster"].map(cluster_names)

Â  Â  with colA:
Â  Â  Â  Â  with st.container(border=True):
Â  Â  Â  Â  Â  Â  fig_r = px.histogram(
Â  Â  Â  Â  Â  Â  df,Â 
Â  Â  Â  Â  Â  Â  x="Recency",Â 
Â  Â  Â  Â  Â  Â  color="Cluster_Name",
Â  Â  Â  Â  Â  Â  title="Recency Distribution per Cluster",
Â  Â  Â  Â  Â  Â  color_discrete_sequence= ["#F8A91F", "#EC6426", "#632713"]
Â  Â  Â  Â  Â  Â  )
Â  Â  Â  Â  Â  Â  fig_r.update_layout(
Â  Â  Â  Â  Â  Â  Â  Â  legend=dict(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  orientation="h",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  yanchor="bottom",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  y=-0.45,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  xanchor="center",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  x=0.5
Â  Â  Â  Â  Â  Â  Â  Â  )
Â  Â  Â  Â  Â  Â  )
Â  Â  Â  Â  Â  Â  fig_r.update_layout(legend_title_text="")
Â  Â  Â  Â  Â  Â  fig_r.update_xaxes(title_text="")
Â  Â  Â  Â  Â  Â  st.plotly_chart(fig_r, use_container_width=True)

Â  Â  with colB:
Â  Â  Â  Â  with st.container(border=True):
Â  Â  Â  Â  Â  Â  fig_f = px.histogram(
Â  Â  Â  Â  Â  Â  df, x="Frequency", color="Cluster_Name",
Â  Â  Â  Â  Â  Â  title="Frequency Distribution per Cluster",
Â  Â  Â  Â  Â  Â  color_discrete_sequence=["#F8A91F", "#EC6426", "#632713"]

Â  Â  Â  Â  Â  Â  )
Â  Â  Â  Â  Â  Â  fig_f.update_layout(
Â  Â  Â  Â  Â  Â  Â  Â  legend=dict(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  orientation="h",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  yanchor="bottom",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  y=-0.45,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  xanchor="center",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  x=0.5
Â  Â  Â  Â  Â  Â  Â  Â  )
Â  Â  Â  Â  Â  Â  )
Â  Â  Â  Â  Â  Â  fig_f.update_layout(legend_title_text="")
Â  Â  Â  Â  Â  Â  fig_f.update_xaxes(title_text="")
Â  Â  Â  Â  Â  Â  st.plotly_chart(fig_f, use_container_width=True)

Â  Â  with colC:
Â  Â  Â  Â  with st.container(border=True):
Â  Â  Â  Â  Â  Â  fig_m = px.histogram(
Â  Â  Â  Â  Â  Â  df, x="Monetary", color="Cluster_Name",
Â  Â  Â  Â  Â  Â  title="Monetary Distribution per Cluster",
Â  Â  Â  Â  Â  Â  color_discrete_sequence=["#F8A91F", "#EC6426", "#632713"]
Â  Â  Â  Â  Â  Â  )
Â  Â  Â  Â  Â  Â  fig_m.update_layout(
Â  Â  Â  Â  Â  Â  Â  Â  legend=dict(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  orientation="h",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  yanchor="bottom",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  y=-0.45,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  xanchor="center",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  x=0.5
Â  Â  Â  Â  Â  Â  Â  Â  )
Â  Â  Â  Â  Â  Â  )
Â  Â  Â  Â  Â  Â  fig_m.update_layout(legend_title_text="")
Â  Â  Â  Â  Â  Â  fig_m.update_xaxes(title_text="")
Â  Â  Â  Â  Â  Â  st.plotly_chart(fig_m, use_container_width=True)
	
Â  Â  # ======================
Â  Â  # CLUSTER DISTRIBUTION + CHANNEL DISTRIBUTION
Â  Â  # ======================
Â  Â 
Â  Â  st.markdown(
Â  Â  Â  Â  "<h3 style='text-align: center;'>Distribusi Cluster & Order Channel</h3>",
Â  Â  Â  Â  unsafe_allow_html=True
Â  Â  )

Â  Â  colA, colB = st.columns(2)

Â  Â  with colA:
Â  Â  Â  Â  with st.container(border=True):
Â  Â  Â  Â  Â  Â  fig_cluster_pie = px.pie(
Â  Â  Â  Â  Â  Â  Â  Â  df,
Â  Â  Â  Â  Â  Â  Â  Â  names="Cluster_Name",
Â  Â  Â  Â  Â  Â  Â  Â  title="Proporsi Pelanggan per Cluster",
Â  Â  Â  Â  Â  Â  Â  Â  color="Cluster_Name",
Â  Â  Â  Â  Â  Â  Â  Â  color_discrete_sequence= ["#E05F00", "#FAAD00", "#FFC746"]
Â  Â  Â  Â  Â  Â  )
Â  Â  Â  Â  Â  Â  st.plotly_chart(fig_cluster_pie, use_container_width=True)


Â  Â  with colB:
Â  Â  Â  Â  with st.container(border=True):
Â  Â  Â  Â  Â  Â  fig_channel = px.bar(
Â  Â  Â  Â  Â  Â  Â  Â  df.groupby(["Cluster_Name", "order_channel"]).size().reset_index(name="count"),
Â  Â  Â  Â  Â  Â  Â  Â  x="Cluster_Name",
Â  Â  Â  Â  Â  Â  Â  Â  y="count",
Â  Â  Â  Â  Â  Â  Â  Â  color="order_channel",
Â  Â  Â  Â  Â  Â  Â  Â  barmode="group",
Â  Â  Â  Â  Â  Â  Â  Â  title="Distribusi Order Channel per Cluster",
Â  Â  Â  Â  Â  Â  Â  Â  color_discrete_sequence=px.colors.sequential.YlOrRd
Â  Â  Â  Â  )
Â  Â  Â  Â  Â  Â  st.plotly_chart(fig_channel, use_container_width=True)

Â  Â Â 

Â  Â  # ======================
Â  Â  # FORM PREDIKSI
Â  Â  # ======================

Â  Â Â 
Â  Â  cluster_reco = {
Â  Â  	0: "Reaktivasi agresif melalui promosi besar atau diskon signifikan, pengiriman pesan win-back seperti â€œKami kangen kamuâ€, serta pemberian voucher dengan masa berlaku singkat. Survei singkat juga bisa dilakukan untuk memahami alasan mereka berhenti bertransaksi.",
Â  Â  	1: "Retensi jangka panjang dengan program loyalitas premium, pelayanan eksklusif, dan reward khusus seperti cashback VIP, poin ekstra, atau bundle premium. Selain itu, mengajak mereka berpartisipasi dalam referral program dapat meningkatkan loyalitas sekaligus akuisisi pelanggan baru.",
Â  Â  	2: "Menjaga engagement melalui pengiriman reminder berkala, promo ringan seperti diskon kecil atau gratis ongkir, serta program loyalitas atau pemberian poin tambahan. Tujuannya adalah agar mereka tetap aktif dan tidak turun menjadi pelanggan tidak aktif."
	}

Â  Â  left, right = st.columns(2)

Â  Â  with left:
Â  Â  Â  Â  st.markdown(
Â  Â  Â  Â  Â  Â  "<h3 style='text-align: center;'>Input Nilai RFM</h3>",
Â  Â  Â  Â  Â  Â  unsafe_allow_html=True
Â  Â  Â  Â  )

Â  Â  Â  Â  start_date = st.date_input("Tanggal terakhir transaksi pelanggan")
Â  Â  Â  Â  end_date = st.date_input("Tanggal analisis", datetime.today())

Â  Â  Â  Â  if start_date > end_date:
Â  Â  Â  Â  Â  Â  st.error("âŒ Tanggal terakhir transaksi tidak boleh melebihi tanggal analisis.")
Â  Â  Â  Â  Â  Â  recency = None
Â  Â  Â  Â  else:
Â  Â  Â  Â  Â  Â  recency = (end_date - start_date).days

Â  Â  Â  Â  freq = st.number_input("Frequency (jumlah transaksi)", min_value=0)
Â  Â  Â  Â  mon = st.number_input("Monetary (total pembelian)", min_value=0)

Â  Â  Â  Â  btn = st.button("Prediksi Cluster")

Â  Â  with right:
Â  Â  Â  Â  st.markdown(
Â  Â  Â  Â  Â  Â  "<h3 style='text-align: center;'>Hasil Prediksi</h3>",
Â  Â  Â  Â  Â  Â  unsafe_allow_html=True
Â  Â  Â  Â  )

Â  Â  Â  Â  if btn and recency is not None:
Â  Â  Â  Â  Â  Â  X_scaled = scaler.transform([[recency, freq, mon]])
Â  Â  Â  Â  Â  Â  X_pca = pca.transform(X_scaled)
Â  Â  Â  Â  Â  Â  cluster_pred = kmeans.predict(X_pca)[0]

Â  Â  Â  Â  Â  Â  cluster_name = cluster_names[cluster_pred]
Â  Â  Â  Â  Â  Â  recommendation = cluster_reco[cluster_pred]

Â  Â  Â  Â  Â  Â  # ---- OUTPUT ----
Â  Â  Â  Â  Â  Â  st.markdown("<div class='result-box'>", unsafe_allow_html=True)
Â  Â  Â  Â  Â  Â  st.success(f"Cluster Prediksi: **{cluster_name}**")
Â  Â  Â  Â  Â  Â  st.info(f"Rekomendasi: {recommendation}")
Â  Â  Â  Â  Â  Â  st.markdown("</div>", unsafe_allow_html=True)
